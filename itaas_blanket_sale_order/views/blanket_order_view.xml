<?xml version="1.0" encoding="utf-8"?>
<!--
Copyright (C) 2015 DevIntelle Consulting Service Pvt.Ltd (<http://www.devintellecs.com>).

For Module Support : devintelle@gmail.com  or Skype : devintelle
 -->
<odoo>
    <record id="form_dev_blanket_sale_order" model="ir.ui.view">
        <field name="name">form.dev.blanket.sale.order</field>
        <field name="model">sale.order</field>
        <field name="priority">99</field>
        <field name="arch" type="xml">
            <form string="Sales Order" class="o_sale_order">
                <header>
                    <button name="open_blanket_order" type="object" class="oe_highlight" string="Open" attrs="{'invisible': [('blanket_state', '!=', 'draft')]}"/>
                    <button name="create_sale_quotation" type="object" class="oe_highlight" string="Create Sale Quotation" attrs="{'invisible': [('blanket_state', '!=', 'open')]}"/>
                    <button name="cancel_blanket_order" type="object" string="Cancel" attrs="{'invisible': [('blanket_state', '!=', 'open')]}"/>
                    <button name="set_to_new_blanket_order" type="object" string="Back to New" attrs="{'invisible': [('blanket_state', '!=', 'cancelled')]}"/>
                    <button name="create_auto_all" type="object" string="Create Auto" attrs="{'invisible': [('blanket_state', '=', 'cancelled')]}"/>
                    <field name="blanket_state" widget="statusbar" statusbar_visible="draft,open,expired"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button type="object" name="view_sale_quotations" class="oe_stat_button" icon="fa-external-link" attrs="{'invisible':[('sale_quote_count', '=', 0)]}">
                            <field string="Sale Orders" name="sale_quote_count" widget="statinfo"/>
                            <field name="blanket_order_ids" invisible="1"/>
                        </button>
                    </div>
                    <div class="oe_title">
                        <h1>
                            <field name="name" readonly="1"/>
                        </h1>
                    </div>
                    <group>
                        <group>
                            <field name="partner_id" widget="res_partner_many2one" context="{'res_partner_search_mode': 'customer', 'show_address': 1, 'show_vat': True}"
                                   options="{&quot;always_reload&quot;: True}" attrs="{'readonly': [('blanket_state', 'in', ['expired', 'cancelled'])]}"/>
                            <field name="partner_invoice_id" groups="sale.group_delivery_invoice_address" context="{'default_type':'invoice'}" options="{&quot;always_reload&quot;: True}" attrs="{'readonly': [('blanket_state', 'in', ['expired', 'cancelled'])]}"/>
                            <field name="partner_shipping_id" groups="sale.group_delivery_invoice_address" context="{'default_type':'delivery'}" options="{&quot;always_reload&quot;: True}" attrs="{'readonly': [('blanket_state', 'in', ['expired', 'cancelled'])]}"/>
                            <field name="state" invisible="1"/>
                            <field name="company_id" invisible="1"/>
                        </group>
                        <group>
                            <div class="o_td_label" groups="base.group_no_one" attrs="{'invisible': [('state', 'in', ['sale', 'done', 'cancel'])]}">
                                <label for="date_order" string="Quotation Date"/>
                            </div>
                            <field name="date_order" nolabel="1" groups="base.group_no_one" attrs="{'readonly': [('blanket_state', 'in', ['expired', 'cancelled'])], 'invisible': [('state', 'in', ['sale', 'done', 'cancel'])]}"/>
                            <div class="o_td_label" attrs="{'invisible': [('state', 'in', ['draft', 'sent'])]}">
                                <label for="date_order" string="Order Date"/>
                            </div>
                            <field name="date_order" attrs="{'readonly': [('blanket_state', 'in', ['expired', 'cancelled'])], 'required': [('state', 'in', ['sale', 'done'])], 'invisible': [('state', 'in', ['draft', 'sent'])]}" nolabel="1"/>
                            <field name="pricelist_id" groups="product.group_product_pricelist" options="{'no_open':True,'no_create': True}" attrs="{'readonly': [('blanket_state', 'in', ['expired', 'cancelled'])]}"/>
                            <field name="currency_id" invisible="1"/>
                            <field name="payment_term_id" options="{'no_open':True,'no_create': True}" attrs="{'readonly': [('blanket_state', 'in', ['expired', 'cancelled'])]}"/>
                            <field name="order_type" invisible="1"/>
                            <field name="start_date" attrs="{'readonly': [('blanket_state', 'in', ['expired', 'cancelled'])], 'required': [('order_type', '=', 'blanket')]}"/>
                            <field name="start_delivery_date" attrs="{'readonly': [('blanket_state', 'in', ['expired', 'cancelled'])], 'required': [('order_type', '=', 'blanket')]}"/>
                            <field name="standard_frequency" attrs="{'readonly': [('blanket_state', 'in', ['expired', 'cancelled'])], 'required': [('order_type', '=', 'blanket')]}"/>
                            <field name="blanket_expiry_date" attrs="{'readonly': [('blanket_state', 'in', ['expired', 'cancelled'])], 'required': [('order_type', '=', 'blanket')]}"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Order Lines" name="order_lines">
                            <field name="order_line" widget="section_and_note_one2many" mode="tree,kanban" attrs="{'readonly': ['|', ('state', 'in', ('done','cancel')), ('blanket_state', 'in', ['expired', 'cancelled'])]}">
                                <form>
                                    <field name="display_type" invisible="1"/>
                                    <!--
                                        We need the sequence field to be here for new lines to be added at the correct position.
                                        TODO: at some point we want to fix this in the framework so that an invisible field is not required.
                                    -->
                                    <field name="sequence" invisible="1"/>
                                    <field name="product_uom_category_id" invisible="1"/>
                                    <group>
                                        <group attrs="{'invisible': [('display_type', '!=', False)]}">
                                            <field name="product_updatable" invisible="1"/>
                                            <field name="product_id" domain="[('sale_ok', '=', True), '|', ('company_id', '=', False), ('company_id', '=', parent.company_id)]"
                                                   context="{'partner_id':parent.partner_id, 'quantity':product_uom_qty, 'pricelist':parent.pricelist_id, 'uom':product_uom, 'company_id': parent.company_id}"
                                                   attrs="{                                                     'readonly': [('product_updatable', '=', False)],                                                     'required': [('display_type', '=', False)],                                                 }"
                                                   force_save="1" widget="many2one_barcode"/>
                                            <field name="invoice_status" invisible="1"/>
                                            <field name="qty_to_invoice" invisible="1"/>
                                            <field name="qty_delivered_manual" invisible="1"/>
                                            <field name="qty_delivered_method" invisible="1"/>
                                            <field name="price_total" invisible="1"/>
                                            <field name="price_tax" invisible="1"/>
                                            <field name="price_subtotal" invisible="1"/>
                                            <label for="product_uom_qty"/>
                                            <div class="o_row" name="ordered_qty">
                                                <field context="{'partner_id':parent.partner_id, 'quantity':product_uom_qty, 'pricelist':parent.pricelist_id, 'uom':product_uom, 'uom_qty_change':True, 'company_id': parent.company_id}"
                                                       name="product_uom_qty"/>
                                                <field name="product_uom" force_save="1" groups="uom.group_uom" class="oe_no_button"
                                                       attrs="{                                                         'readonly': [('state', 'in', ('sale', 'done', 'cancel'))],                                                         'required': [('display_type', '=', False)],                                                     }"/>
                                            </div>
                                            <field name="remaining_qty"/>
                                            <label for="qty_delivered" string="Delivered" attrs="{'invisible': [('parent.state', 'not in', ['sale', 'done'])]}"/>
                                            <div name="delivered_qty" attrs="{'invisible': [('parent.state', 'not in', ['sale', 'done'])]}">
                                                <field name="qty_delivered" attrs="{'readonly': [('qty_delivered_method', '!=', 'manual')]}"/>
                                            </div>
                                            <label for="qty_invoiced" string="Invoiced" attrs="{'invisible': [('parent.state', 'not in', ['sale', 'done'])]}"/>
                                            <div name="invoiced_qty" attrs="{'invisible': [('parent.state', 'not in', ['sale', 'done'])]}">
                                                <field name="qty_invoiced" attrs="{'invisible': [('parent.state', 'not in', ['sale', 'done'])]}"/>
                                            </div>
                                            <field name="price_unit"/>
                                            <field name="tax_id" widget="many2many_tags" options="{'no_create': True}" context="{'search_view_ref': 'account.account_tax_view_search'}"
                                                   domain="[('type_tax_use','=','sale'),('company_id','=',parent.company_id)]" attrs="{'readonly': [('qty_invoiced', '&gt;', 0)]}"/>
                                            <label for="discount" groups="product.group_discount_per_so_line"/>
                                            <div name="discount" groups="product.group_discount_per_so_line">
                                                <field name="discount" class="oe_inline"/>
                                                %
                                            </div>
                                            <field name="sequence" invisible="1"/>
                                        </group>
                                        <group attrs="{'invisible': [('display_type', '!=', False)]}">
                                            <label for="customer_lead"/>
                                            <div name="lead">
                                                <field name="customer_lead" class="oe_inline"/>
                                                days
                                            </div>
                                            <field name="analytic_tag_ids" widget="many2many_tags" groups="analytic.group_analytic_tags" options="{'color_field': 'color'}"
                                                   domain="['|', ('company_id', '=', False), ('company_id', '=', parent.company_id)]"/>
                                        </group>
                                    </group>
                                    <label for="name" string="Description" attrs="{'invisible': [('display_type', '!=', False)]}"/>
                                    <label for="name" string="Section Name (eg. Products, Services)" attrs="{'invisible': [('display_type', '!=', 'line_section')]}"/>
                                    <label for="name" string="Note" attrs="{'invisible': [('display_type', '!=', 'line_note')]}"/>
                                    <field name="name"/>
                                    <div name="invoice_lines" groups="base.group_no_one" attrs="{'invisible': [('display_type', '!=', False)]}">
                                        <label for="invoice_lines"/>
                                        <field name="invoice_lines"/>
                                    </div>
                                    <field name="state" invisible="1"/>
                                    <field name="company_id" invisible="1"/>
                                </form>
                                <tree string="Sales Order Lines" editable="bottom" decoration-info="(not display_type and invoice_status == 'to invoice')">
                                    <control>
                                        <create name="add_product_control" string="Add a product"/>
                                        <create name="add_section_control" string="Add a section" context="{'default_display_type': 'line_section'}"/>
                                        <create name="add_note_control" string="Add a note" context="{'default_display_type': 'line_note'}"/>
                                    </control>

                                    <field name="sequence" widget="handle"/>
                                    <!-- We do not display the type because we don't want the user to be bothered with that information if he has no section or note. -->
                                    <field name="display_type" invisible="1"/>
                                    <field name="product_uom_category_id" invisible="1"/>

                                    <field name="product_updatable" invisible="1"/>
                                    <field name="product_id"
                                           attrs="{                                             'readonly': [('product_updatable', '=', False)],                                             'required': [('display_type', '=', False)],                                         }"
                                           options="{'no_open': True}" force_save="1"
                                           context="{                                             'partner_id': parent.partner_id,                                             'quantity': product_uom_qty,                                             'pricelist': parent.pricelist_id,                                             'uom':product_uom,                                             'company_id': parent.company_id,                                             'default_lst_price': price_unit,                                             'default_description_sale': name                                         }"
                                           domain="[('sale_ok', '=', True), '|', ('company_id', '=', False), ('company_id', '=', parent.company_id)]" widget="product_configurator"/>
                                    <field name="product_template_id" string="Product" invisible="1"
                                           attrs="{                                           'readonly': [('product_updatable', '=', False)],                                           'required': [('display_type', '=', False)],                                       }"
                                           options="{'no_open': True}"
                                           context="{                                           'partner_id': parent.partner_id,                                           'quantity': product_uom_qty,                                           'pricelist': parent.pricelist_id,                                           'uom':product_uom,                                           'company_id': parent.company_id,                                           'default_lst_price': price_unit,                                           'default_description_sale': name                                       }"
                                           domain="[('sale_ok', '=', True), '|', ('company_id', '=', False), ('company_id', '=', parent.company_id)]" widget="product_configurator"/>
                                    <field name="name" widget="section_and_note_text" optional="show"/>
                                    <field name="analytic_tag_ids" optional="hide" groups="analytic.group_analytic_tags" widget="many2many_tags" options="{'color_field': 'color'}"
                                           domain="['|', ('company_id', '=', False), ('company_id', '=', parent.company_id)]"/>
                                    <field name="product_uom_qty"
                                           context="{                                             'partner_id': parent.partner_id,                                             'quantity': product_uom_qty,                                             'pricelist': parent.pricelist_id,                                             'uom': product_uom,                                             'company_id': parent.company_id                                         }"/>
                                    <field name="consumed_qty"/>
                                    <field name="remaining_qty"/>
                                    <field name="delivered_qty"/>
                                    <field name="remain_delivered_qty"/>
                                    <field name="standard_qty"/>
                                    <field name="period"/>
                                    <field name="next_date"/>
                                    <field name="next_delivery_date"/>
                                    <field name="qty_delivered" string="Delivered"
                                           attrs="{                                             'column_invisible': [('parent.state', 'not in', ['sale', 'done'])],                                             'readonly': [('qty_delivered_method', '!=', 'manual')]                                         }"
                                           optional="show"/>
                                    <field name="qty_delivered_manual" invisible="1"/>
                                    <field name="qty_delivered_method" invisible="1"/>
                                    <field name="qty_invoiced" string="Invoiced" attrs="{'column_invisible': [('parent.state', 'not in', ['sale', 'done'])]}" optional="show"/>
                                    <field name="qty_to_invoice" invisible="1"/>
                                    <field name="product_uom" force_save="1" string="UoM"
                                           attrs="{                                             'readonly': [('state', 'in', ('sale','done', 'cancel'))],                                             'required': [('display_type', '=', False)],                                         }"
                                           context="{'company_id': parent.company_id}" groups="uom.group_uom" options="{&quot;no_open&quot;: True}" optional="show"/>
                                    <field name="customer_lead" optional="hide"/>
                                    <field name="price_unit" attrs="{'readonly': [('qty_invoiced', '&gt;', 0)]}"/>
                                    <field name="tax_id" widget="many2many_tags" options="{'no_create': True}" domain="[('type_tax_use','=','sale'),('company_id','=',parent.company_id)]"
                                           attrs="{'readonly': [('qty_invoiced', '&gt;', 0)]}" optional="show"/>
                                    <field name="discount" string="Disc.%" groups="product.group_discount_per_so_line" optional="show"/>
                                    <field name="price_subtotal" widget="monetary" groups="account.group_show_line_subtotals_tax_excluded"/>
                                    <field name="price_total" widget="monetary" groups="account.group_show_line_subtotals_tax_included"/>
                                    <field name="state" invisible="1"/>
                                    <field name="invoice_status" invisible="1"/>
                                    <field name="currency_id" invisible="1"/>
                                    <field name="price_tax" invisible="1"/>
                                    <field name="company_id" invisible="1"/>
                                </tree>
                                <kanban class="o_kanban_mobile">
                                    <field name="name"/>
                                    <field name="product_id"/>
                                    <field name="product_uom_qty"/>
                                    <field name="product_uom" groups="uom.group_uom"/>
                                    <field name="price_subtotal"/>
                                    <field name="price_tax" invisible="1"/>
                                    <field name="price_total" invisible="1"/>
                                    <field name="price_unit"/>
                                    <field name="display_type"/>
                                    <field name="tax_id" invisible="1"/>
                                    <field name="company_id" invisible="1"/>
                                    <templates>
                                        <t t-name="kanban-box">
                                            <div t-attf-class="oe_kanban_card oe_kanban_global_click {{ record.display_type.raw_value ? 'o_is_' + record.display_type.raw_value : '' }}">
                                                <t t-if="!record.display_type.raw_value">
                                                    <div class="row">
                                                        <div class="col-8">
                                                            <strong>
                                                                <span>
                                                                    <t t-esc="record.product_id.value"/>
                                                                </span>
                                                            </strong>
                                                        </div>
                                                        <div class="col-4">
                                                            <strong>
                                                                <span class="float-right text-right">
                                                                    <t t-esc="record.price_subtotal.value"/>
                                                                </span>
                                                            </strong>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-12 text-muted">
                                                            <span>
                                                                Quantity:
                                                                <t t-esc="record.product_uom_qty.value"/>
                                                                <t t-esc="record.product_uom.value"/>
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-12 text-muted">
                                                            <span>
                                                                Unit Price:
                                                                <t t-esc="record.price_unit.value"/>
                                                            </span>
                                                        </div>
                                                    </div>
                                                </t>
                                                <t t-if="record.display_type.raw_value === 'line_section' || record.display_type.raw_value === 'line_note'">
                                                    <div class="row">
                                                        <div class="col-12">
                                                            <span>
                                                                <t t-esc="record.name.value"/>
                                                            </span>
                                                        </div>
                                                    </div>
                                                </t>
                                            </div>
                                        </t>
                                    </templates>
                                </kanban>
                            </field>
                            <group name="note_group" col="6">
                                <group colspan="4">
                                    <field name="note" nolabel="1" placeholder="Terms and conditions..." attrs="{'readonly': [('blanket_state', 'in', ['expired', 'cancelled'])]}"/>
                                </group>
                                <group class="oe_subtotal_footer oe_right" colspan="2" name="sale_total">
                                    <field name="amount_untaxed" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                                    <field name="amount_tax" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                                    <div class="oe_subtotal_footer_separator oe_inline o_td_label">
                                        <label for="amount_total"/>
                                    </div>
                                    <field name="amount_total" nolabel="1" class="oe_subtotal_footer_separator" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                                </group>
                                <div class="oe_clear"/>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids" widget="mail_followers"/>
                    <field name="activity_ids" widget="mail_activity"/>
                    <field name="message_ids" widget="mail_thread"/>
                </div>
            </form>
        </field>
    </record>

    <record id="tree_dev_blanket_sale_order" model="ir.ui.view">
        <field name="name">tree.dev.blanket.sale.order</field>
        <field name="model">sale.order</field>
        <field name="priority">99</field>
        <field name="arch" type="xml">
            <tree string="Quotation" class="o_sale_order" decoration-bf="message_needaction==True" decoration-muted="state=='cancel'" multi_edit="1">
                <field name="message_needaction" invisible="1"/>
                <field name="name" string="Quotation Number" readonly="1"/>
                <field name="create_date" string="Create Date"/>
                <field name="partner_id" readonly="1"/>
                <field name="user_id" optional="show"/>
                <field name="team_id" optional="hide"/>
                <field name="company_id" groups="base.group_multi_company" optional="show" readonly="1"/>
                <field name="amount_untaxed" sum="Total Tax Excluded" widget="monetary" optional="hide"/>
                <field name="amount_tax" sum="Tax Total" widget="monetary" optional="hide"/>
                <field name="amount_total" sum="Total Tax Included" widget="monetary" optional="show"/>
                <field name="currency_id" invisible="1"/>
                <field name="blanket_expiry_date"/>
                <field name="activity_exception_decoration" widget="activity_exception"/>
                <field name="state" invisible="1"/>
                <field name="blanket_state" string="Status"/>
            </tree>
        </field>
    </record>

    <!--Action-->
    <record id="action_Blanket_orders" model="ir.actions.act_window">
        <field name="name">Blanket Orders</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">sale.order</field>
        <field name="view_mode">tree,form</field>
        <field name="context">{'default_order_type' : 'blanket'}</field>
        <field name="domain">[('order_type', '=', 'blanket')]</field>
    </record>

    <record model="ir.actions.act_window.view" id="action_blanket_tree_view">
        <field name="sequence" eval="1"/>
        <field name="view_mode">tree</field>
        <field name="view_id" ref="tree_dev_blanket_sale_order"/>
        <field name="act_window_id" ref="action_Blanket_orders"/>
    </record>
    <record model="ir.actions.act_window.view" id="action_blanket_form_view">
        <field name="sequence" eval="1"/>
        <field name="view_mode">form</field>
        <field name="view_id" ref="form_dev_blanket_sale_order"/>
        <field name="act_window_id" ref="action_Blanket_orders"/>
    </record>

    <!--Menus-->
    <menuitem name="Blanket Orders"
              id='menu_blanket_orders'
              parent="sale.sale_order_menu"
              action="action_Blanket_orders"
              sequence="2"/>
</odoo>